{"version":3,"file":"usePersonalization-DKPi6Nos.js","sources":["../../src/hooks/usePersonalization.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface PersonalizationData {\r\n  calculationHistory: any[];\r\n  complianceAlerts: any[];\r\n  favoriteMaterials: any[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n}\r\n\r\nexport const usePersonalization = (userId: string | undefined) => {\r\n  const [data, setData] = useState<PersonalizationData>({\r\n    calculationHistory: [],\r\n    complianceAlerts: [],\r\n    favoriteMaterials: [],\r\n    isLoading: true,\r\n    error: null\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!userId) {\r\n      setData(prev => ({ ...prev, isLoading: false }));\r\n      return;\r\n    }\r\n\r\n    fetchPersonalizationData();\r\n  }, [userId]);\r\n\r\n  const fetchPersonalizationData = async () => {\r\n    if (!userId) return;\r\n\r\n    try {\r\n      setData(prev => ({ ...prev, isLoading: true, error: null }));\r\n\r\n      // Fetch calculation history\r\n      const { data: historyData, error: historyError } = await supabase\r\n        .from('user_calculation_history')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(20);\r\n\r\n      if (historyError) throw historyError;\r\n\r\n      // Fetch compliance alerts\r\n      const { data: alertsData, error: alertsError } = await supabase\r\n        .from('user_compliance_alerts')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (alertsError) throw alertsError;\r\n\r\n      // Fetch favorite materials with material details\r\n      const { data: favoritesData, error: favoritesError } = await supabase\r\n        .from('user_material_favorites')\r\n        .select(`\r\n          *,\r\n          material:unified_materials(\r\n            id,\r\n            name,\r\n            carbon_footprint_kgco2e_kg,\r\n            category,\r\n            description\r\n          )\r\n        `)\r\n        .eq('user_id', userId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (favoritesError) throw favoritesError;\r\n\r\n      setData({\r\n        calculationHistory: historyData || [],\r\n        complianceAlerts: alertsData || [],\r\n        favoriteMaterials: favoritesData || [],\r\n        isLoading: false,\r\n        error: null\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error fetching personalization data:', error);\r\n      setData(prev => ({\r\n        ...prev,\r\n        isLoading: false,\r\n        error: 'Failed to load personalization data'\r\n      }));\r\n    }\r\n  };\r\n\r\n  const addToFavorites = async (materialId: string, category?: string, notes?: string) => {\r\n    if (!userId) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_material_favorites')\r\n        .insert([{\r\n          user_id: userId,\r\n          material_id: materialId,\r\n          category,\r\n          notes\r\n        }]);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Material added to favorites');\r\n      fetchPersonalizationData(); // Refresh data\r\n    } catch (error) {\r\n      console.error('Error adding to favorites:', error);\r\n      toast.error('Failed to add material to favorites');\r\n    }\r\n  };\r\n\r\n  const removeFromFavorites = async (materialId: string) => {\r\n    if (!userId) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_material_favorites')\r\n        .delete()\r\n        .eq('user_id', userId)\r\n        .eq('material_id', materialId);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Material removed from favorites');\r\n      fetchPersonalizationData(); // Refresh data\r\n    } catch (error) {\r\n      console.error('Error removing from favorites:', error);\r\n      toast.error('Failed to remove material from favorites');\r\n    }\r\n  };\r\n\r\n  const markAlertAsRead = async (alertId: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_compliance_alerts')\r\n        .update({ is_read: true })\r\n        .eq('id', alertId);\r\n\r\n      if (error) throw error;\r\n\r\n      setData(prev => ({\r\n        ...prev,\r\n        complianceAlerts: prev.complianceAlerts.map(alert =>\r\n          alert.id === alertId ? { ...alert, is_read: true } : alert\r\n        )\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error marking alert as read:', error);\r\n      toast.error('Failed to update alert');\r\n    }\r\n  };\r\n\r\n  const saveCalculationHistory = async (\r\n    calculatorType: string,\r\n    calculationData: any,\r\n    results: any,\r\n    carbonFootprint?: number,\r\n    complianceStatus?: string,\r\n    improvementSuggestions?: string[]\r\n  ) => {\r\n    if (!userId) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_calculation_history')\r\n        .insert([{\r\n          user_id: userId,\r\n          calculator_type: calculatorType,\r\n          calculation_data: calculationData,\r\n          results,\r\n          carbon_footprint: carbonFootprint,\r\n          compliance_status: complianceStatus,\r\n          improvement_suggestions: improvementSuggestions\r\n        }]);\r\n\r\n      if (error) throw error;\r\n\r\n      // Refresh data to show new calculation\r\n      fetchPersonalizationData();\r\n    } catch (error) {\r\n      console.error('Error saving calculation history:', error);\r\n      // Don't show error toast as this is background operation\r\n    }\r\n  };\r\n\r\n  const createComplianceAlert = async (\r\n    alertType: string,\r\n    title: string,\r\n    message: string,\r\n    severity: 'info' | 'warning' | 'critical' = 'info',\r\n    relatedStandard?: string,\r\n    actionRequired: boolean = false,\r\n    expiresAt?: Date\r\n  ) => {\r\n    if (!userId) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_compliance_alerts')\r\n        .insert([{\r\n          user_id: userId,\r\n          alert_type: alertType,\r\n          title,\r\n          message,\r\n          severity,\r\n          related_standard: relatedStandard,\r\n          action_required: actionRequired,\r\n          expires_at: expiresAt?.toISOString()\r\n        }]);\r\n\r\n      if (error) throw error;\r\n\r\n      fetchPersonalizationData(); // Refresh data\r\n    } catch (error) {\r\n      console.error('Error creating compliance alert:', error);\r\n    }\r\n  };\r\n\r\n  return {\r\n    ...data,\r\n    addToFavorites,\r\n    removeFromFavorites,\r\n    markAlertAsRead,\r\n    saveCalculationHistory,\r\n    createComplianceAlert,\r\n    refreshData: fetchPersonalizationData\r\n  };\r\n};"],"names":["usePersonalization","userId","data","setData","useState","useEffect","prev","fetchPersonalizationData","historyData","historyError","supabase","alertsData","alertsError","favoritesData","favoritesError","error","materialId","category","notes","toast","alertId","alert","calculatorType","calculationData","results","carbonFootprint","complianceStatus","improvementSuggestions","alertType","title","message","severity","relatedStandard","actionRequired","expiresAt"],"mappings":"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"}